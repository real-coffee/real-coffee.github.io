<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¸”ë¡ ì•„íŠ¸ ìƒì„±ê¸° (ë¬¸ì â†’ ã…/ì´ëª¨ì§€)</title>
  <style>
    :root {
      --bg: #f7f7fb; --card: #ffffff; --ink: #111827; --muted: #6b7280; --brand:#4f46e5;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", Arial, sans-serif; background: var(--bg); color: var(--ink); }
    .wrap { max-width: 1024px; margin: 0 auto; padding: 24px; }
    .card { background: var(--card); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.06); padding: 16px; }
    h1 { font-size: clamp(20px, 3vw, 28px); margin: 0 0 8px; }
    p.small { color: var(--muted); margin: 0 0 16px; font-size: 13px; }
    .grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 768px) { .grid-3 { grid-template-columns: repeat(3, 1fr); } }
    .row { display: grid; gap: 6px; }
    label { font-size: 13px; color: var(--muted); }
    input[type="text"], input[type="number"], button, select { height: 40px; }
    input[type="text"], input[type="number"], select {
      width: 100%; border: 1px solid #e5e7eb; border-radius: 10px; padding: 0 12px; background: white;
      outline: none; transition: box-shadow .15s, border-color .15s;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(79,70,229,.15); }
    input[type="range"] { width: 100%; }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .btn { border: 0; background: var(--brand); color: white; border-radius: 10px; padding: 0 12px; cursor: pointer; }
    .btn:hover { filter: brightness(0.95); }
    .btn-ghost { background: #eef2ff; color: #3730a3; }
    .mono { white-space: pre; overflow: auto; background: #0b1020; color: #e5e7eb; border-radius: 12px; padding: 12px; line-height: 1em; font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hint { font-size: 12px; color: var(--muted); }
    .row-inline { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .switch { display: inline-flex; gap: 6px; align-items: center; font-size: 13px; }
    .footer { color: var(--muted); font-size: 12px; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row-inline" style="justify-content: space-between;">
        <h1>ë¸”ë¡ ì•„íŠ¸ ìƒì„±ê¸° (ë¬¸ì â†’ ã…/ì´ëª¨ì§€/ì„ì˜ë¬¸ì)</h1>
        <div class="controls">
          <button class="btn btn-ghost" id="presetPc" title="PC í•´ìƒë„ í”„ë¦¬ì…‹">PC(64)</button>
          <button class="btn btn-ghost" id="presetMo" title="ëª¨ë°”ì¼ í•´ìƒë„ í”„ë¦¬ì…‹">Mobile(20)</button>
        </div>
      </div>
      <p class="small">ì…ë ¥í•œ ê¸€ìë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë ¤ì„œ ìƒ˜í”Œë§í•œ ë’¤, ì„ íƒí•œ ë¬¸ì(ã…/ì´ëª¨ì§€ ë“±)ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. í•œê¸€Â·ì˜ë¬¸Â·ì´ëª¨ì§€ ëª¨ë‘ ê°€ëŠ¥. :emoji: ë‹¨ì¶•ì–´ ì¼ë¶€ ì§€ì›(ì˜ˆ: <code>:coffee:</code> â†’ â˜•).</p>

      <div class="grid grid-3">
        <div class="row">
          <label>í…ìŠ¤íŠ¸</label>
          <input type="text" id="text" placeholder="ì˜ˆ: ë”° or Hello or ì•ˆë…• ğŸ˜€" value="ë”°" />
          <div class="hint">ë‘˜ ì´ìƒ ê¸€ìëŠ” í•´ìƒë„(ê°€ë¡œ ë¸”ë¡ ìˆ˜)ë¥¼ ì˜¬ë¦¬ì„¸ìš”.</div>
        </div>
        <div class="row">
          <label>ê°€ë¡œ ë¸”ë¡ ìˆ˜: <span id="colsVal">64</span></label>
          <input type="range" id="cols" min="8" max="160" value="64" />
          <div class="hint">ëª¨ë°”ì¼ì€ 8â€“24 ê¶Œì¥. í™”ë©´ì´ ì¢ì„ìˆ˜ë¡ ë‚®ì¶”ê¸°.</div>
        </div>
        <div class="row">
          <label>ê°ë„(ì„ê³„ê°’): <span id="thVal">140</span></label>
          <input type="range" id="th" min="40" max="220" value="140" />
          <div class="hint">ë‚®ì¶œìˆ˜ë¡ ë” ì§„í•˜ê²Œ ì±„ì›Œì§‘ë‹ˆë‹¤.</div>
        </div>
      </div>

      <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div class="row">
          <label>ë¸”ë¡(ì „ê²½) ë¬¸ì (ì´ëª¨ì§€ ê°€ëŠ¥)</label>
          <input type="text" id="fg" value="ã…" />
          <div class="hint">ì˜ˆ: ã…, â–ˆ, â—, ğŸ˜€, â˜•, or <code>:coffee:</code> (ì¼ë¶€ ë‹¨ì¶•ì–´ ì§€ì›)</div>
        </div>
        <div class="row">
          <label>ë°°ê²½ ë¬¸ì</label>
          <input type="text" id="bg" value="ã€€" />
          <div class="hint">ê¸°ë³¸ì€ ì „ê° ê³µë°±(U+3000) â€“ í­ ì •ë ¬ì— ìœ ë¦¬</div>
        </div>
      </div>

      <div class="row-inline" style="margin: 8px 0; gap: 16px;">
        <label class="switch"><input type="checkbox" id="bold" checked> êµµê²Œ(bold)</label>
        <label class="switch">ì¤„ ê°„ê²©(ë¹ˆ ì¤„): <input type="number" id="linespace" min="0" max="3" value="0" style="width:64px"></label>
        <label class="switch">í°íŠ¸:
          <select id="fontSel">
            <option value="Apple SD Gothic Neo,Malgun Gothic,Noto Sans KR,Arial Unicode MS,sans-serif">í•œê¸€ ê°€ë…ì„±</option>
            <option value="Noto Sans KR,Apple SD Gothic Neo,Malgun Gothic,Arial Unicode MS,sans-serif">Noto Sans KR</option>
            <option value="Segoe UI,Roboto,system-ui,sans-serif">ì˜ë¬¸ ìœ„ì£¼</option>
            <option value="ui-monospace,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace">Monospace</option>
          </select>
        </label>
        <div class="controls">
          <button class="btn" id="copyBtn">ê²°ê³¼ ë³µì‚¬</button>
          <button class="btn" id="downloadBtn">.txt ì €ì¥</button>
        </div>
      </div>

      <div class="row">
        <label>ê²°ê³¼</label>
        <pre id="out" class="mono" style="min-height: 160px;">(ì—¬ê¸°ì— ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤)</pre>
      </div>

      <canvas id="hiddenCanvas" width="1" height="1" style="display:none"></canvas>
      <div class="footer">íŒ: ë‹¨ìƒ‰ ë¬¸ì(ã…, â–ˆ ë“±)ì¼ìˆ˜ë¡ ê¹”ë”í•©ë‹ˆë‹¤. ì´ëª¨ì§€ëŠ” í­ì´ ì¼ì •ì¹˜ ì•Šì•„ ì¤„ë§ì¶¤ì´ ì•½ê°„ ì–´ê¸‹ë‚  ìˆ˜ ìˆì–´ìš”.</div>
    </div>
  </div>

  <script>
    // ê°„ë‹¨í•œ :emoji: ë‹¨ì¶•ì–´ ë§¤í•‘ (í•„ìš” ì‹œ ì¶”ê°€)
    const EMOJI_MAP = {
      ":coffee:": "â˜•", ":fire:": "ğŸ”¥", ":star:": "â­", ":sparkles:": "âœ¨",
      ":heart:": "â¤ï¸", ":thumbsup:": "ğŸ‘", ":clap:": "ğŸ‘", ":check:": "âœ…",
      ":x:": "âŒ", ":smile:": "ğŸ˜„", ":lol:": "ğŸ˜‚", ":rocket:": "ğŸš€"
    };
    function resolveEmojiShortcodes(s) {
      return s.replace(/:[a-z0-9_+-]+:/gi, m => EMOJI_MAP[m.toLowerCase()] || m);
    }

    // ì²« ë²ˆì§¸ ê·¸ë˜í”¼ë©”(ì´ëª¨ì§€ í¬í•¨) ì•ˆì „ ì¶”ì¶œ
    function firstGrapheme(str, fallback = "ã…") {
      if (!str) return fallback;
      const s = resolveEmojiShortcodes(str.trim());
      if (typeof Intl !== 'undefined' && Intl.Segmenter) {
        const seg = new Intl.Segmenter('ko', { granularity: 'grapheme' });
        const it = seg.segment(s)[Symbol.iterator]();
        const { value } = it.next();
        return value ? value.segment : fallback;
      }
      // Fallback: ëˆˆë¬¼ì˜ naive - ì´ëª¨ì§€ ê²°í•©ë¬¸ìì—” ì™„ë²½í•˜ì§„ ì•ŠìŒ
      return s.codePointAt ? String.fromCodePoint(s.codePointAt(0)) : (s[0] || fallback);
    }

    const qs = sel => document.querySelector(sel);
    const text = qs('#text');
    const cols = qs('#cols');
    const colsVal = qs('#colsVal');
    const th = qs('#th');
    const thVal = qs('#thVal');
    const fg = qs('#fg');
    const bg = qs('#bg');
    const bold = qs('#bold');
    const linespace = qs('#linespace');
    const out = qs('#out');
    const fontSel = qs('#fontSel');
    const canvas = qs('#hiddenCanvas');
    const presetPc = qs('#presetPc');
    const presetMo = qs('#presetMo');
    const copyBtn = qs('#copyBtn');
    const downloadBtn = qs('#downloadBtn');

    // ì´ˆê¸°ê°’: ëª¨ë°”ì¼ì´ë©´ 20, PCë©´ 64
    if (window.innerWidth < 640) cols.value = 20;
    colsVal.textContent = cols.value;
    thVal.textContent = th.value;

    function render() {
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      const txt = text.value || '';
      const fgChar = firstGrapheme(fg.value, 'ã…');
      const bgChar = firstGrapheme(bg.value || '\u3000', '\u3000');
      const threshold = parseInt(th.value, 10) || 140;
      const weight = bold.checked ? 800 : 400;
      const font = fontSel.value;

      if (!txt.trim()) { out.textContent = ''; return; }

      // ìº”ë²„ìŠ¤ì— í¬ê²Œ ê·¸ë¦° ë‹¤ìŒ ìƒ˜í”Œë§
      const baseFontSize = 240;
      ctx.font = `${weight} ${baseFontSize}px ${font}`;
      const metrics = ctx.measureText(txt);
      const textWidth = Math.ceil(metrics.width) + 40;
      const ascent = Math.ceil(metrics.actualBoundingBoxAscent || baseFontSize * 0.8);
      const descent = Math.ceil(metrics.actualBoundingBoxDescent || baseFontSize * 0.2);
      const textHeight = ascent + descent + 40;

      canvas.width = Math.max(1, textWidth);
      canvas.height = Math.max(1, textHeight);
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#000000';
      ctx.textBaseline = 'alphabetic';
      ctx.font = `${weight} ${baseFontSize}px ${font}`;
      ctx.fillText(txt, 20, 20 + ascent);

      const COLS = Math.max(1, parseInt(cols.value, 10) || 64);
      const ROWS = Math.max(1, Math.round((canvas.height / canvas.width) * COLS));

      const img = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
      const cellW = canvas.width / COLS;
      const cellH = canvas.height / ROWS;

      const lines = [];
      for (let r = 0; r < ROWS; r++) {
        let line = '';
        for (let c = 0; c < COLS; c++) {
          const x0 = Math.floor(c * cellW);
          const y0 = Math.floor(r * cellH);
          const x1 = Math.min(canvas.width, Math.floor((c + 1) * cellW));
          const y1 = Math.min(canvas.height, Math.floor((r + 1) * cellH));
          let sum = 0, cnt = 0;
          for (let y = y0; y < y1; y++) {
            for (let x = x0; x < x1; x++) {
              const idx = (y * canvas.width + x) * 4;
              const lum = (img[idx] + img[idx+1] + img[idx+2]) / 3; // ë‹¨ìˆœ í‰ê· 
              sum += lum; cnt++;
            }
          }
          const avg = cnt ? sum / cnt : 255;
          line += (avg < threshold) ? fgChar : bgChar;
        }
        lines.push(line);
        const extra = Math.max(0, Math.min(3, parseInt(linespace.value || '0', 10)));
        for (let k = 0; k < extra; k++) lines.push('');
      }
      while (lines.length && lines[0].trim().length === 0) lines.shift();
      while (lines.length && lines[lines.length-1].trim().length === 0) lines.pop();

      out.textContent = lines.join('\n');
      colsVal.textContent = COLS;
      thVal.textContent = threshold;
    }

    [text, cols, th, fg, bg, bold, linespace, fontSel].forEach(el => el.addEventListener('input', render));
    window.addEventListener('resize', () => { /* no-op autoscale */ });

    presetPc.addEventListener('click', () => { cols.value = 64; render(); });
    presetMo.addEventListener('click', () => { cols.value = 20; render(); });

    copyBtn.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(out.textContent || ''); } catch(e) { alert('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨: ' + e); }
    });

    downloadBtn.addEventListener('click', () => {
      const blob = new Blob([out.textContent || ''], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'block-art.txt';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    });

    // ìµœì´ˆ ë Œë”
    render();
  </script>
</body>
</html>
